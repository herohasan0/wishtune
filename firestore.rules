rules_version = '2';

  service cloud.firestore {
    match /databases/{database}/documents {

      // Helper function to check if user is authenticated
      function isAuthenticated() {
        return request.auth != null;
      }

      // Helper function to check if user owns the resource
      function isOwner(userId) {
        return isAuthenticated() && request.auth.uid == userId;
      }

      // Songs collection
      match /songs/{songId} {
        // Allow authenticated users to read songs
        // This includes both logged-in users and anonymous Firebase users
        // Security: Users can read but never write (all writes are server-side)
        allow get, list: if isAuthenticated();

        // All writes must happen server-side via Firebase Admin SDK
        allow write: if false;
      }

      // User credits - users can only read their own credit information
      match /userCredits/{userId} {
        // Allow users to read only their own credits
        allow read: if isOwner(userId);

        // All writes must happen server-side to prevent manipulation
        allow write: if false;
      }

      // Anonymous usages - no client access (admin only)
      match /anonymous_usages/{visitorId} {
        allow read: if false;
        allow write: if false;
      }

      // Transactions - no client access (admin only)
      match /transactions/{transactionId} {
        allow read: if false;
        allow write: if false;
      }

      // Payment sessions - no client access (admin only)
      match /paymentSessions/{sessionId} {
        allow read: if false;
        allow write: if false;
      }

      // Deny all other collections by default
      match /{document=**} {
        allow read, write: if false;
      }
    }
  }